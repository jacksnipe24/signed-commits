name: Format code with Prettier and open pull request

on:
  push:
    branches:
      - main

jobs:
  createPullRequest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'

      - name: Install dependencies
        run: yarn

      - name: Set up Git credentials
        uses: ./.github/actions/setup-git-credentials

      - name: Bump version
        run: |
          if ! npm version major ; then
            MESSAGE="Failed to tick version with `npm version $VERSION_INSTRUCTION`"
            echo "MESSAGE=$MESSAGE" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          PACKAGE_VERSION=$(cat package.json \
            | grep version \
            | head -1 \
            | awk -F: '{ print $2 }' \
            | sed 's/[", ]//g')  
          echo "VERSION_TAG=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Create New Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "b name ${{ steps.get_version.outputs.VERSION_TAG }}"
          git checkout -b version-bump/${{ steps.get_version.outputs.VERSION_TAG }}
          gh api -X POST /repos/:owner/:repo/git/refs -f ref="refs/heads/main" -f sha="$GITHUB_SHA" -f "ref=refs/heads/version-bump/${{ steps.get_version.outputs.VERSION_TAG }}"

      - name: Print Branches
        run: |
          git branch -a
          echo branch name is  version-bump/${{ steps.get_version.outputs.VERSION_TAG }}
        

      - name: OPEN PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api --method POST /repos/:owner/:repo/pulls \
            --field title="Bump version to ${{ steps.get_version.outputs.VERSION_TAG }}" \
            --field body="PR body" \
            --field head="version-bump/${{ steps.get_version.outputs.VERSION_TAG }}" \
            --field base="main"    
     
